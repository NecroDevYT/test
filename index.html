<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plants vs. Zombies - Nivel 1</title>
    <style>
        body {
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        canvas {
            /* Tamaño visual ajustado a la pantalla, manteniendo aspect ratio */
            max-width: 100%;
            max-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas" width="1636" height="1332"></canvas>

<script>
// --- CONFIGURACIÓN GLOBAL ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // Ajustar coordenadas del mouse al tamaño real del canvas visual
    function getMousePos(evt) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
            x: (evt.clientX - rect.left) * scaleX,
            y: (evt.clientY - rect.top) * scaleY
        };
    }

    // Estado del Juego
    let frames = 0;
    let sunAmount = 150; // Empezamos con un poco más para probar
    let suns = []; 
    let plants = []; // Array de plantas en el tablero
    let gridState = []; // Matriz para controlar celdas ocupadas
    let selectedSeed = null; // Planta seleccionada actualmente

    // Configuración de Grid
    const GRID_START_X = 90;
    const GRID_START_Y = 280;
    const GRID_END_X = 1577;
    const GRID_END_Y = 1260;
    const COLS = 9;
    const ROWS = 5;
    const CELL_WIDTH = (GRID_END_X - GRID_START_X) / COLS;
    const CELL_HEIGHT = (GRID_END_Y - GRID_START_Y) / ROWS;

    // Inicializar matriz de grid vacía
    for (let c = 0; c < COLS; c++) {
        gridState[c] = [];
        for (let r = 0; r < ROWS; r++) {
            gridState[c][r] = null; // null = vacía
        }
    }

    // Configuración de Semillas y Escalas 
    const seeds = [
        { 
            name: 'girasol', 
            img: 'semilla de girasol.png', 
            cost: 50, 
            scale: 0.3,
            frameCount: 58, // 00 a 57 [cite: 9]
            folder: 'girasol perturbador',
            prefix: 'girasol perturbador'
        },
        { 
            name: 'lanzaguisantes', 
            img: 'semilla de lanza guisantes.png', 
            cost: 100, 
            scale: 0.35, // 
            frameCount: 31, // 00 a 30 [cite: 19]
            folder: 'lg reposo perturbador',
            prefix: 'lg reposo perturbador'
        },
        { 
            name: 'nuez', 
            img: 'semilla de nuez.png', 
            cost: 50, 
            scale: 0.3,
            frameCount: 1, // Solo nuez0 [cite: 19]
            folder: 'nuez',
            prefix: 'nuez'
        }
    ];

    // --- GESTOR DE RECURSOS ---
    const assets = {
        sunAnimation: [],
        plants: {
            girasol: [],
            lanzaguisantes: [],
            nuez: []
        }
    };
    
    const imageSources = {
        background: 'recursos/background.png',
        barraSemillas: 'recursos/barra de semillas.png',
        pala: 'recursos/pala.png',
        solUI: 'recursos/sol.png', 
        envoltura: 'recursos/envoltura de semilla.png',
        cortacesped: 'recursos/cortacesped.png',
        seed_girasol: 'recursos/semilla de girasol.png',
        seed_lanzaguisantes: 'recursos/semilla de lanza guisantes.png',
        seed_nuez: 'recursos/semilla de nuez.png'
    };

    // 1. Cargar Animación Sol (000-191)
    for (let i = 0; i <= 191; i++) {
        const index = String(i).padStart(3, '0');
        imageSources[`sol_anim_${i}`] = `recursos/sol/sol${index}.png`;
    }

    // 2. Cargar Animaciones Plantas
    // Girasol (00-57)
    for (let i = 0; i <= 57; i++) {
        const index = String(i).padStart(2, '0');
        imageSources[`plant_girasol_${i}`] = `recursos/girasol perturbador/girasol perturbador${index}.png`;
    }
    // Lanzaguisantes (00-30)
    for (let i = 0; i <= 30; i++) {
        const index = String(i).padStart(2, '0');
        imageSources[`plant_lanzaguisantes_${i}`] = `recursos/lg reposo perturbador/lg reposo perturbador${index}.png`;
    }
    // Nuez (0)
    imageSources[`plant_nuez_0`] = `recursos/nuez/nuez0.png`;

    let assetsLoaded = 0;
    const totalAssets = Object.keys(imageSources).length;

    function loadImages(callback) {
        console.log(`Cargando recursos...`);
        for (let key in imageSources) {
            const img = new Image();
            img.src = imageSources[key];
            img.onload = () => {
                // Clasificar imágenes en sus arrays correspondientes
                if (key.startsWith('sol_anim_')) {
                    const idx = parseInt(key.replace('sol_anim_', ''));
                    assets.sunAnimation[idx] = img;
                } else if (key.startsWith('plant_girasol_')) {
                    const idx = parseInt(key.replace('plant_girasol_', ''));
                    assets.plants.girasol[idx] = img;
                } else if (key.startsWith('plant_lanzaguisantes_')) {
                    const idx = parseInt(key.replace('plant_lanzaguisantes_', ''));
                    assets.plants.lanzaguisantes[idx] = img;
                } else if (key.startsWith('plant_nuez_')) {
                    assets.plants.nuez[0] = img;
                } else {
                    assets[key] = img;
                }
                
                assetsLoaded++;
                if (assetsLoaded === totalAssets) callback();
            };
        }
    }

    // --- CLASES ---

    class Sun {
        constructor() {
            this.x = Math.random() * (GRID_END_X - GRID_START_X) + GRID_START_X;
            this.y = -80;
            this.finalY = Math.random() * (GRID_END_Y - GRID_START_Y) + GRID_START_Y;
            this.speed = 3; 
            this.frame = 0;
            this.totalFrames = assets.sunAnimation.length;
            this.scale = 0.5;
            this.markedForDeletion = false;
            // Hitbox radius (aprox) para clic
            this.radius = 40; 
        }

        update() {
            // Animación constante
            if (frames % 2 === 0) { 
                this.frame++;
                if (this.frame >= this.totalFrames) this.markedForDeletion = true;
            }
            // Caída
            if (this.y < this.finalY) {
                this.y += this.speed;
                if (this.y > this.finalY) this.y = this.finalY;
            }
        }

        draw() {
            if (this.markedForDeletion) return;
            const currentFrame = this.frame < this.totalFrames ? this.frame : this.totalFrames - 1;
            const img = assets.sunAnimation[currentFrame];
            if (!img) return;

            const width = img.width * this.scale;
            const height = img.height * this.scale;
            // Dibujar centrado
            ctx.drawImage(img, this.x - width/2, this.y - height/2, width, height);
        }

        isClicked(mx, my) {
            // Distancia euclidiana simple
            const dx = mx - this.x;
            const dy = my - this.y;
            return Math.sqrt(dx*dx + dy*dy) < this.radius;
        }
    }

    class Plant {
        constructor(typeIndex, col, row) {
            const seedInfo = seeds[typeIndex];
            this.type = seedInfo.name;
            this.col = col;
            this.row = row;
            
            // Posición centrada en la celda
            this.x = GRID_START_X + (col * CELL_WIDTH) + (CELL_WIDTH / 2);
            this.y = GRID_START_Y + (row * CELL_HEIGHT) + (CELL_HEIGHT / 2);
            
            this.scale = seedInfo.scale;
            this.frame = 0;
            this.frameCount = seedInfo.frameCount;
            this.animSpeed = 2; // Actualizar cada 2 frames (30fps)
        }

        update() {
            if (this.frameCount > 1 && frames % this.animSpeed === 0) {
                this.frame++;
                if (this.frame >= this.frameCount) this.frame = 0; // Loop
            }
        }

        draw() {
            const arr = assets.plants[this.type];
            const img = arr[this.frame] || arr[0];
            
            const w = img.width * this.scale;
            const h = img.height * this.scale;
            
            // Hitbox/Dibujo en el centro [cite: 52]
            ctx.drawImage(img, this.x - w/2, this.y - h/2, w, h);
        }
    }

    // --- INTERACCIÓN ---
    let mouseX = 0;
    let mouseY = 0;

    canvas.addEventListener('mousemove', (e) => {
        const pos = getMousePos(e);
        mouseX = pos.x;
        mouseY = pos.y;
    });

    canvas.addEventListener('mousedown', (e) => {
        const pos = getMousePos(e);
        const mx = pos.x;
        const my = pos.y;

        // 1. Recoger Soles (Iterar al revés para agarrar el de arriba primero visualmente)
        let sunClicked = false;
        for (let i = suns.length - 1; i >= 0; i--) {
            if (suns[i].isClicked(mx, my)) {
                suns.splice(i, 1);
                sunAmount += 25; // Sumar sol
                sunClicked = true;
                break; // Solo un sol por clic
            }
        }
        if (sunClicked) return;

        // 2. Selección en Barra de Semillas
        // Calcular rangos de la UI (hardcodeado según lógica de dibujado UI anterior)
        let currentX = 200;
        const wrapperWidth = assets.envoltura.width; // Asumimos cargado
        
        // Si hago click derecho o click fuera, deseleccionar
        if (selectedSeed) {
            // Intentar Plantar
            if (mx >= GRID_START_X && mx <= GRID_END_X && my >= GRID_START_Y && my <= GRID_END_Y) {
                const col = Math.floor((mx - GRID_START_X) / CELL_WIDTH);
                const row = Math.floor((my - GRID_START_Y) / CELL_HEIGHT);
                
                if (gridState[col][row] === null) {
                    // Plantar
                    plants.push(new Plant(selectedSeed.index, col, row));
                    gridState[col][row] = selectedSeed.name; // Ocupar celda
                    sunAmount -= selectedSeed.cost;
                    selectedSeed = null; // Deseleccionar tras plantar
                }
            } else {
                // Cancelar selección si click fuera de grid (opcional)
                selectedSeed = null; 
            }
            return; 
        }

        // Seleccionar nueva semilla
        seeds.forEach((seed, index) => {
            // Chequear si click en esta semilla (Rango X: currentX a currentX+width, Y: 20 a 20+height)
            // Altura envoltura es aprox 140px (segun imagen)
            if (mx >= currentX && mx <= currentX + wrapperWidth &&
                my >= 20 && my <= 20 + 100) { // Altura aproximada clickeable
                
                if (sunAmount >= seed.cost) {
                    selectedSeed = { ...seed, index: index };
                }
            }
            currentX += wrapperWidth;
        });
    });


    // --- DIBUJADO UI & JUEGO ---

    function drawUI() {
        ctx.drawImage(assets.background, 0, 0);
        ctx.drawImage(assets.barraSemillas, 10, 10);

        // Sol UI
        const sunRangeCenter = 10 + (190 / 2);
        const sunImgX = sunRangeCenter - (assets.solUI.width / 2);
        ctx.drawImage(assets.solUI, sunImgX, 0);
        
        ctx.fillStyle = 'black'; 
        ctx.font = 'bold 40px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(sunAmount, sunRangeCenter, 195);

        // Pala UI
        const shovelRangeCenter = 1110 + (127 / 2);
        const shovelX = shovelRangeCenter - (assets.pala.width / 2);
        ctx.drawImage(assets.pala, shovelX, 0);

        // Semillas
        let currentX = 200;
        seeds.forEach(seed => {
            const wrapperWidth = assets.envoltura.width;
            
            // Oscurecer si no alcanza el dinero
            ctx.globalAlpha = (sunAmount >= seed.cost) ? 1.0 : 0.5;
            
            ctx.drawImage(assets.envoltura, currentX, 20);
            
            const plantImg = assets['seed_' + seed.name];
            const plantX = currentX + (wrapperWidth - plantImg.width) / 2;
            ctx.drawImage(plantImg, plantX, 0);

            ctx.fillStyle = 'black';
            ctx.font = 'bold 25px Arial';
            ctx.fillText(seed.cost, currentX + (wrapperWidth / 2), 183);

            currentX += wrapperWidth; 
        });
        ctx.globalAlpha = 1.0; // Reset alpha
    }

    function drawEntities() {
        // Cortacesped
        const lawnmowerX = -70;
        for (let row = 0; row < ROWS; row++) {
            const rowY = GRID_START_Y + (row * CELL_HEIGHT);
            const centerY = rowY + (CELL_HEIGHT / 2);
            const lmY = centerY - (assets.cortacesped.height / 2);
            ctx.drawImage(assets.cortacesped, lawnmowerX, lmY);
        }
    }

    function drawGhostPlant() {
        if (selectedSeed) {
            // Obtener primera imagen de la planta seleccionada
            let img;
            if (selectedSeed.name === 'nuez') img = assets.plants.nuez[0];
            else if (selectedSeed.name === 'girasol') img = assets.plants.girasol[0];
            else img = assets.plants.lanzaguisantes[0];

            if (img) {
                const w = img.width * selectedSeed.scale;
                const h = img.height * selectedSeed.scale;
                
                ctx.globalAlpha = 0.6; // Transparencia fantasma
                // Seguir al mouse (centrado)
                ctx.drawImage(img, mouseX - w/2, mouseY - h/2, w, h);
                ctx.globalAlpha = 1.0;
            }
        }
    }

    // --- BUCLE PRINCIPAL ---
    function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        drawUI();
        
        // Dibujar Grid (debajo de plantas)
        ctx.strokeStyle = 'rgba(255, 0, 0, 0.3)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let i = 0; i <= COLS; i++) {
            const x = GRID_START_X + (i * CELL_WIDTH);
            ctx.moveTo(x, GRID_START_Y);
            ctx.lineTo(x, GRID_END_Y);
        }
        for (let i = 0; i <= ROWS; i++) {
            const y = GRID_START_Y + (i * CELL_HEIGHT);
            ctx.moveTo(GRID_START_X, y);
            ctx.lineTo(GRID_END_X, y);
        }
        ctx.stroke();

        drawEntities(); // Cortacesped

        // Actualizar y Dibujar Plantas
        plants.forEach(plant => {
            plant.update();
            plant.draw();
        });

        // Actualizar y Dibujar Soles
        if (frames % 300 === 0) suns.push(new Sun());

        for (let i = 0; i < suns.length; i++) {
            suns[i].update();
            suns[i].draw();
            if (suns[i].markedForDeletion) {
                suns.splice(i, 1);
                i--;
            }
        }

        // Dibujar planta en el mouse si hay selección
        drawGhostPlant();

        frames++;
        requestAnimationFrame(gameLoop);
    }

    // Iniciar
    loadImages(() => {
        console.log("Juego Iniciado");
        gameLoop();
    });
</script>
</body>
</html>