<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plants vs. Zombies - Nivel 1</title>
    <style>
        body {
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        canvas {
            /* Tamaño visual ajustado a la pantalla, manteniendo aspect ratio */
            max-width: 100%;
            max-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas" width="1636" height="1332"></canvas>

<script>
// --- CONFIGURACIÓN GLOBAL ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // Estado del Juego
    let frames = 0; // Contador global de frames para sincronización
    let sunAmount = 50; 
    let suns = []; // Array para almacenar los objetos "Sol" activos
    
    // Configuración de Grid
    const GRID_START_X = 90;
    const GRID_START_Y = 280;
    const GRID_END_X = 1577;
    const GRID_END_Y = 1260;
    const COLS = 9;
    const ROWS = 5;
    const CELL_WIDTH = (GRID_END_X - GRID_START_X) / COLS;
    const CELL_HEIGHT = (GRID_END_Y - GRID_START_Y) / ROWS;

    // Configuración de Semillas
    const seeds = [
        { name: 'girasol', img: 'semilla de girasol.png', cost: 50 },
        { name: 'lanzaguisantes', img: 'semilla de lanza guisantes.png', cost: 100 },
        { name: 'nuez', img: 'semilla de nuez.png', cost: 50 }
    ];

    // --- GESTOR DE RECURSOS ---
    const assets = {
        sunAnimation: [] // Array para guardar la secuencia del sol
    };
    
    const imageSources = {
        background: 'recursos/background.png',
        barraSemillas: 'recursos/barra de semillas.png',
        pala: 'recursos/pala.png',
        solUI: 'recursos/sol.png', 
        envoltura: 'recursos/envoltura de semilla.png',
        cortacesped: 'recursos/cortacesped.png',
        seed_girasol: 'recursos/semilla de girasol.png',
        seed_lanzaguisantes: 'recursos/semilla de lanza guisantes.png',
        seed_nuez: 'recursos/semilla de nuez.png'
    };

    // Generar rutas para la animación del sol (000 a 191)
    // Fuente: Estructura.txt indica sol000.png hasta sol191.png
    for (let i = 0; i <= 191; i++) {
        // Formatear número a 3 dígitos (ej: 0 -> "000", 15 -> "015")
        const index = String(i).padStart(3, '0');
        imageSources[`sol_anim_${i}`] = `recursos/sol/sol${index}.png`;
    }

    let assetsLoaded = 0;
    const totalAssets = Object.keys(imageSources).length;

    function loadImages(callback) {
        console.log(`Cargando ${totalAssets} recursos...`);
        for (let key in imageSources) {
            const img = new Image();
            img.src = imageSources[key];
            img.onload = () => {
                // Si es parte de la animación del sol, guardarlo en el array ordenado
                if (key.startsWith('sol_anim_')) {
                    const index = parseInt(key.replace('sol_anim_', ''));
                    assets.sunAnimation[index] = img;
                } else {
                    assets[key] = img;
                }
                
                assetsLoaded++;
                if (assetsLoaded === totalAssets) {
                    callback();
                }
            };
            img.onerror = () => {
                console.error("Error cargando: " + imageSources[key]);
            }
        }
    }

    // --- CLASES ---

    class Sun {
        constructor() {
            // Posición X aleatoria dentro del grid
            this.x = Math.random() * (GRID_END_X - GRID_START_X) + GRID_START_X;
            // Posición Y inicial (fuera de pantalla arriba)
            this.y = -80;
            // Destino Y aleatorio dentro del grid
            this.finalY = Math.random() * (GRID_END_Y - GRID_START_Y) + GRID_START_Y;
            
            this.speed = 2; // Velocidad de caída
            this.frame = 0;
            this.totalFrames = assets.sunAnimation.length;
            this.scale = 0.5; // Instrucción: Escala 0.5
            this.isFalling = true;
            this.markedForDeletion = false;
        }

        update() {
            // 1. Lógica de Caída
            if (this.isFalling) {
                this.y += this.speed;
                if (this.y >= this.finalY) {
                    this.y = this.finalY;
                    this.isFalling = false;
                }
            } else {
                // 2. Lógica de Animación (Solo cuando está en el suelo)
                // Ejecutar a 30 FPS. Si el juego va a 60 FPS, actualizamos cada 2 frames globales.
                if (frames % 2 === 0) {
                    this.frame++;
                    // Instrucción: "Cuando el sol termine un ciclo de animación elimina el sol"
                    if (this.frame >= this.totalFrames) {
                        this.markedForDeletion = true;
                    }
                }
            }
        }

        draw() {
            if (this.markedForDeletion) return;

            const img = assets.sunAnimation[this.frame] || assets.sunAnimation[0];
            
            // Dibujar desde el centro (Hitbox en el centro)
            // Calculamos la posición top-left basada en el centro deseado (x, y) y la escala
            const width = img.width * this.scale;
            const height = img.height * this.scale;
            const drawX = this.x - (width / 2);
            const drawY = this.y - (height / 2);

            ctx.drawImage(img, drawX, drawY, width, height);
        }
    }

    // --- FUNCIONES DE DIBUJADO BASE ---

    function drawGrid() {
        ctx.strokeStyle = 'rgba(255, 0, 0, 0.5)'; // Rojo semi-transparente
        ctx.lineWidth = 2;
        ctx.beginPath();
        for (let i = 0; i <= COLS; i++) {
            const x = GRID_START_X + (i * CELL_WIDTH);
            ctx.moveTo(x, GRID_START_Y);
            ctx.lineTo(x, GRID_END_Y);
        }
        for (let i = 0; i <= ROWS; i++) {
            const y = GRID_START_Y + (i * CELL_HEIGHT);
            ctx.moveTo(GRID_START_X, y);
            ctx.lineTo(GRID_END_X, y);
        }
        ctx.stroke();
    }

    function drawUI() {
        ctx.drawImage(assets.background, 0, 0);
        ctx.drawImage(assets.barraSemillas, 10, 10);

        // Sol UI
        const sunRangeCenter = 10 + (190 / 2);
        const sunImgX = sunRangeCenter - (assets.solUI.width / 2);
        ctx.drawImage(assets.solUI, sunImgX, 0);
        
        ctx.fillStyle = 'black'; 
        ctx.font = 'bold 40px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(sunAmount, sunRangeCenter, 195);

        // Pala UI
        const shovelRangeCenter = 1110 + (127 / 2);
        const shovelX = shovelRangeCenter - (assets.pala.width / 2);
        ctx.drawImage(assets.pala, shovelX, 0);

        // Semillas
        let currentX = 200;
        seeds.forEach(seed => {
            const wrapperWidth = assets.envoltura.width;
            ctx.drawImage(assets.envoltura, currentX, 20);
            
            const plantImg = assets['seed_' + seed.name];
            const plantX = currentX + (wrapperWidth - plantImg.width) / 2;
            ctx.drawImage(plantImg, plantX, 0);

            ctx.fillStyle = 'black';
            ctx.font = 'bold 25px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(seed.cost, currentX + (wrapperWidth / 2), 183);

            currentX += wrapperWidth; 
        });
    }

    function drawEntities() {
        // Cortacesped
        const lawnmowerX = -70;
        for (let row = 0; row < ROWS; row++) {
            const rowY = GRID_START_Y + (row * CELL_HEIGHT);
            const centerY = rowY + (CELL_HEIGHT / 2);
            const lmY = centerY - (assets.cortacesped.height / 2);
            ctx.drawImage(assets.cortacesped, lawnmowerX, lmY);
        }
    }

    // --- BUCLE PRINCIPAL ---
    function gameLoop() {
        // Limpieza
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // 1. Dibujar UI estática
        drawUI();
        drawGrid();
        drawEntities(); // Cortacesped (entidades estáticas por ahora)

        // 2. Lógica y Dibujado de Soles
        // Generar sol cada 300 frames (aprox 5 segundos)
        if (frames % 300 === 0) {
            suns.push(new Sun());
        }

        // Actualizar y dibujar soles
        for (let i = 0; i < suns.length; i++) {
            suns[i].update();
            suns[i].draw();
            
            // Eliminar si terminó animación
            if (suns[i].markedForDeletion) {
                suns.splice(i, 1);
                i--;
            }
        }

        frames++;
        requestAnimationFrame(gameLoop);
    }

    // Iniciar
    loadImages(() => {
        console.log("Recursos cargados. Iniciando Nivel 1.");
        gameLoop();
    });
</script>
</body>
</html>